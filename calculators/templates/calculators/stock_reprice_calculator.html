{# calculators/templates/calculators/stock_reprice_calculator.html #}
{% extends 'base.html' %}
{% load static %}
{% load calculator_filters %}

{% block title %}Stock Reprice Calculator - StockSavvy{% endblock %}

{% block content %}
<div class="container calculator-page">
    <div class="header">
        <h1>Stock Reprice Calculator</h1>
        <p>Analyse your stock holdings and re-pricing scenarios with precision</p>
    </div>

    {# Django Messages (Displays info, error, success messages from views.py) #}
    {% if messages %}
        <ul class="messages list-unstyled mb-4">
            {% for message in messages %}
                <li class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}" role="alert">
                    {{ message }}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    {# The 'user-feedback-alert' div is likely redundant if using Django messages above #}
    {# <div class="alert alert-info text-center" id="user-feedback-alert" style="display:none;" role="alert"></div> #}

    <form method="post" id="repriceCalculatorForm">
        {% csrf_token %}

        {# Django Non-field errors #}
        {% if form.non_field_errors %}
            <div style="color: red; margin-bottom: 20px; border: 1px solid red; padding: 10px;">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <div class="calculator-grid">
            <div class="card">
                <h2>Current Holdings</h2>

                <div class="form-group">
                    {{ form.stock_symbol.label_tag }}
                    {{ form.stock_symbol|add_class:"calculator-input" }}
                    {% if form.stock_symbol.errors %}<div class="text-danger error-message">{{ form.stock_symbol.errors }}</div>{% endif %}
                    {% if form.stock_symbol.help_text %}<small class="form-text text-muted">{{ form.stock_symbol.help_text }}</small>{% endif %}
                </div>

                <div class="form-row">
                    <div class="form-group">
                        {{ form.current_shares.label_tag }}
                        {{ form.current_shares|add_class:"calculator-input" }}
                        {% if form.current_shares.errors %}<div class="text-danger error-message">{{ form.current_shares.errors }}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.average_buy_price.label_tag }}
                        {{ form.average_buy_price|add_class:"calculator-input" }}
                        {# Corrected error field name #}
                        {% if form.average_buy_price.errors %}<div class="text-danger error-message">{{ form.average_buy_price.errors }}</div>{% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Initial Total Cost Price ($)</label>
                        <div class="display-value" id="costPrice">{{ results.total_cost_price|floatformat:2|default:"0.00" }}</div>
                    </div>
                    <div class="form-group">
                        {{ form.current_market_price.label_tag }}
                        {{ form.current_market_price|add_class:"calculator-input" }}
                        {# Corrected error field name #}
                        {% if form.current_market_price.errors %}<div class="text-danger error-message">{{ form.current_market_price.errors }}</div>{% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Current Portfolio Value ($)</label>
                    <div class="display-value" id="currentValue">{{ results.current_portfolio_value|floatformat:2|default:"0.00" }}</div>
                </div>

                <div class="form-group">
                    <label>Profit & Loss (P&L)</label>
                    <div class="display-value" id="pl">{{ results.p_l_initial|floatformat:2|default:"0.00" }}</div>
                </div>
            </div>

            <div class="card">
                <h2>Reprice Calculator</h2>

                <div class="form-group">
                    {{ form.calculation_mode.label_tag }}
                    {{ form.calculation_mode|add_class:"calculator-select" }}
                    {# Corrected error field name #}
                    {% if form.calculation_mode.errors %}<div class="text-danger error-message">{{ form.calculation_mode.errors }}</div>{% endif %}
                </div>

                <div id="sharesModeInputs">
                    <div class="form-group">
                        {{ form.additional_shares_to_buy.label_tag }}
                        {{ form.additional_shares_to_buy|add_class:"calculator-input" }}
                        {# Corrected error field name #}
                        {% if form.additional_shares_to_buy.errors %}<div class="text-danger error-message">{{ form.additional_shares_to_buy.errors }}</div>{% endif %}
                    </div>
                </div>

                <div id="priceModeInputs" style="display: none;">
                    <div class="form-group">
                        {{ form.target_average_price.label_tag }}
                        {{ form.target_average_price|add_class:"calculator-input" }}
                        {# Corrected error field name #}
                        {% if form.target_average_price.errors %}<div class="text-danger error-message">{{ form.target_average_price.errors }}</div>{% endif %}
                        <div id="targetPriceHint" class="form-text text-muted">
                            Target average price must be above current price and below your current average.
                        </div>
                    </div>
                </div>

                <button type="submit" class="calculate-btn calculator-button" id="mainCalculateBtn">Calculate Reprice</button>
                <button type="button" class="calculate-btn calculator-button" id="mainClearBtn" style="background-color: #f0f0f0; color: #555; margin-top: 10px;">Clear All Inputs</button>

                <div class="results-section" id="resultsSection" style="display: {% if results and results.calculation_successful %}block{% else %}none{% endif %};">
                    <h3>Repriced Portfolio</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>New Average Price ($)</label>
                            <div class="display-value" id="newAvg">{{ results.new_average_price|floatformat:2|default:"0.00" }}</div>
                        </div>
                        <div class="form-group">
                            <label>Total Investment ($)</label>
                            <div class="display-value" id="totalCost">{{ results.total_investment|floatformat:2|default:"0.00" }}</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Additional Shares Needed</label>
                            <div class="display-value" id="calculatedShares">
                                {# Now directly display the value, it's correctly set in the view #}
                                {{ results.additional_shares_needed|floatformat:4|default:"0" }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Total Shares After Purchase</label>
                            <div class="display-value" id="totalShares">{{ results.total_shares_after_purchase|floatformat:4|default:"0" }}</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Cost of New Shares ($)</label>
                        <div class="display-value" id="newCost">{{ results.cost_of_new_shares|floatformat:2|default:"0.00" }}</div>
                    </div>
                    <div class="form-group">
                        <label>New Portfolio Value ($)</label>
                        <div class="display-value" id="portfolioValueAfterPurchase">{{ results.portfolio_value_after_purchase|floatformat:2|default:"0.00" }}</div>
                    </div>
                    <div class="form-group">
                        <label>New P&L ($)</label>
                        <div class="display-value" id="p_l_after_purchase">{{ results.p_l_after_purchase|floatformat:2|default:"0.00" }}</div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    {# This modal will be triggered by JavaScript if show_modal_for_signup is True #}
    <div class="modal fade" id="loginSignupModal" tabindex="-1" role="dialog" aria-labelledby="loginSignupModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
    <h3 class="modal-title" id="loginSignupModalLabel">Access Restricted</h3>
    {# All content related to the "x" button should be completely removed here #}
</div>  
                <div class="modal-body">
                    <p>You can use the calculator once as a guest. Please log in or sign up to continue using it.</p>
                </div>
            
                <div class="modal-footer">
                    <a href="{% url 'accounts:login' %}" class="btn btn-primary">Login</a>
                    <a href="{% url 'accounts:register' %}" class="btn btn-success">Sign Up</a>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock content %}

{% block extra_body %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to elements
        const repriceForm = document.getElementById('repriceCalculatorForm');
        // Corrected ID to match Django's default for 'calculation_mode' field
        const calcModeSelect = document.getElementById('id_calculation_mode'); 
        const sharesModeInputs = document.getElementById('sharesModeInputs');
        const priceModeInputs = document.getElementById('priceModeInputs');
        const clearInputsButton = document.getElementById('mainClearBtn');
        const resultsSection = document.getElementById('resultsSection');

        // Form inputs (using their Django-generated IDs)
        const stockSymbolInput = document.getElementById('id_stock_symbol');
        const currentSharesInput = document.getElementById('id_current_shares');
        const avgBuyPriceInput = document.getElementById('id_average_buy_price'); // Corrected ID
        const currentPriceInput = document.getElementById('id_current_market_price'); // Corrected ID
        const newSharesInput = document.getElementById('id_additional_shares_to_buy'); // Corrected ID
        const targetAvgPriceInput = document.getElementById('id_target_average_price'); // Corrected ID

        // Display values (using your new IDs)
        const costPriceDisplay = document.getElementById('costPrice');
        const currentValueDisplay = document.getElementById('currentValue');
        const plDisplay = document.getElementById('pl');
        const newAvgDisplay = document.getElementById('newAvg');
        const totalCostDisplay = document.getElementById('totalCost');
        const calculatedSharesDisplay = document.getElementById('calculatedShares');
        const totalSharesDisplay = document.getElementById('totalShares');
        const newCostDisplay = document.getElementById('newCost');
        const portfolioValueAfterPurchaseDisplay = document.getElementById('portfolioValueAfterPurchase');
        const plAfterPurchaseDisplay = document.getElementById('p_l_after_purchase');


        // Function to format numbers to 2 decimal places (currency)
        function formatCurrency(value) {
            return parseFloat(value).toFixed(2);
        }

        // Function to format shares to 4 decimal places
        function formatShares(value) {
            return parseFloat(value).toFixed(4);
        }

        // Function to update initial values on input change (client-side preview)
        function updateInitialCalculations() {
            const currentShares = parseFloat(currentSharesInput.value) || 0;
            const avgBuyPrice = parseFloat(avgBuyPriceInput.value) || 0;
            const currentPrice = parseFloat(currentPriceInput.value) || 0;

            const totalCostPrice = currentShares * avgBuyPrice;
            const currentPortfolioValue = currentShares * currentPrice;
            const p_l_initial = currentPortfolioValue - totalCostPrice;

            costPriceDisplay.textContent = formatCurrency(totalCostPrice);
            currentValueDisplay.textContent = formatCurrency(currentPortfolioValue);
            plDisplay.textContent = formatCurrency(p_l_initial);
        }

        // Toggle fields visibility based on calculation mode
        function toggleFields() {
            if (calcModeSelect.value === 'shares') { // Make sure this value matches your form's choice value
                sharesModeInputs.style.display = 'block';
                priceModeInputs.style.display = 'none';
                targetAvgPriceInput.value = ''; // Clear target price if switching away
                newSharesInput.setAttribute('required', 'required');
                targetAvgPriceInput.removeAttribute('required');
            } else if (calcModeSelect.value === 'price') { // Make sure this value matches your form's choice value
                sharesModeInputs.style.display = 'none';
                priceModeInputs.style.display = 'block';
                newSharesInput.value = ''; // Clear new shares if switching away
                targetAvgPriceInput.setAttribute('required', 'required');
                newSharesInput.removeAttribute('required');
            }
        }

        // Clear All Inputs button functionality
        if (clearInputsButton) {
            clearInputsButton.addEventListener('click', function() {
                repriceForm.reset(); // Resets all form fields
                // Reset custom display values to 0.00
                costPriceDisplay.textContent = '0.00';
                currentValueDisplay.textContent = '0.00';
                plDisplay.textContent = '0.00';
                newAvgDisplay.textContent = '0.00';
                totalCostDisplay.textContent = '0.00';
                calculatedSharesDisplay.textContent = '0';
                totalSharesDisplay.textContent = '0';
                newCostDisplay.textContent = '0.00';
                portfolioValueAfterPurchaseDisplay.textContent = '0.00';
                plAfterPurchaseDisplay.textContent = '0.00';

                // Assuming 'shares' is the default value from your forms.py
                calcModeSelect.value = 'shares'; 
                toggleFields(); // Ensure correct fields are shown/hidden
                resultsSection.style.display = 'none'; // Hide results section
                // document.getElementById('user-feedback-alert').style.display = 'none'; // No longer needed if using Django messages
            });
        }

        // Event Listeners
        if (calcModeSelect) {
            calcModeSelect.addEventListener('change', toggleFields);
            toggleFields(); // Initialize on load based on default value
        }

        // Add input event listeners for real-time initial calculation preview
        currentSharesInput.addEventListener('input', updateInitialCalculations);
        avgBuyPriceInput.addEventListener('input', updateInitialCalculations);
        currentPriceInput.addEventListener('input', updateInitialCalculations);

        // Initialize initial calculations on page load with existing data (if any)
        updateInitialCalculations();

        // Check if we need to show the modal (set by Django view context)
        // This will be 'true' or 'false' as a string from Django's yesno filter
        const showModalOnLoad = "{{ show_modal_for_signup|yesno:'true,false' }}"; 
        
        if (showModalOnLoad === 'true') {
            // Using jQuery/Bootstrap 4 syntax for modal. Ensure jQuery and Bootstrap JS are loaded.
            if (typeof jQuery !== 'undefined' && $.fn.modal) { 
                $('#loginSignupModal').modal('show');
            } else {
                console.warn("jQuery or Bootstrap's modal JS not loaded. Cannot show login/signup modal.");
                // Fallback for visual message if JS fails to load modal
                const modalDiv = document.getElementById('loginSignupModal');
                if (modalDiv) {
                    modalDiv.style.display = 'block';
                    modalDiv.style.opacity = '1';
                    modalDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
                }
            }
        }
    });
    
</script>
{% endblock extra_body %}