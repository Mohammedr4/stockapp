{% extends 'base.html' %}
{% load static %}

{% block title %}Stock Reprice Calculator - StockSavvy{% endblock title %}

{% block content %}
<style>
        body { 
            background-color: #f8f9fa; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .calculator-container { 
            max-width: 1140px; 
            margin: auto; 
        }
        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: stretch;
        }
        .card {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-radius: 0.75rem;
            padding: 30px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .card-title { 
            font-weight: 600; 
            color: #2c3e50; 
            margin-bottom: 25px; 
            font-size: 1.25rem;
        }
        .form-control { 
            border-radius: 0.5rem; 
            border: 1px solid #ced4da;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
        }
        .form-control:focus {
            color: #495057;
            background-color: #fff;
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: normal;
            color: #495057;
            font-size: 0.875rem;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-right: -5px;
            margin-left: -5px;
        }
        .form-row > .form-group,
        .form-row > .col,
        .form-row > [class*="col-"] {
            padding-right: 5px;
            padding-left: 5px;
        }
        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }
        .calculated-field {
            background-color: #f0f2f5;
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            min-height: calc(1.5em + 0.75rem + 2px);
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #343a40;
            font-size: 1rem;
            line-height: 1.5;
        }
        .pnl-value.text-success { 
            color: #28a745 !important; 
            font-weight: 600; 
        }
        .pnl-value.text-danger { 
            color: #dc3545 !important; 
            font-weight: 600; 
        }

        .calc-btn {
            width: 100%; 
            padding: 12px; 
            font-size: 1rem; 
            font-weight: 600;
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            transition: all 0.2s ease-in-out;
            text-align: center;
            vertical-align: middle;
            user-select: none;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }
        .btn-primary.calc-btn { 
            background-color: #007bff; 
            color: white; 
            border: 1px solid #007bff;
        }
        .btn-primary.calc-btn:hover { 
            background-color: #0069d9; 
            border-color: #0062cc;
        }
        .btn-primary.calc-btn:disabled { 
            background-color: #007bff; 
            opacity: 0.65;
            cursor: not-allowed; 
        }
        .btn-light.calc-btn { 
            background-color: #f8f9fa; 
            color: #212529; 
            border: 1px solid #f8f9fa; 
        }
        .btn-light.calc-btn:hover { 
            background-color: #e2e6ea; 
            border-color: #dae0e5;
        }

        .repriced-portfolio-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
        }
        
        .dashed-divider {
            border: 0;
            border-top: 2px dashed #e9ecef;
            margin: 1.75rem 0;
        }
        
        @media (max-width: 991.98px) { 
            .calculator-grid { 
                grid-template-columns: 1fr; 
            }
            .col-md-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }
        .header h1 {
            color: #212529;
            font-weight: normal;
            margin-bottom: 0.5rem;
            font-size: 2.5rem;
            line-height: 1.2;
        }
        .header .lead {
            color: #6c757d;
            font-size: 1.25rem;
            font-weight: 300;
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        .container {
            width: 100%;
            padding-right: 15px;
            padding-left: 15px;
            margin-right: auto;
            margin-left: auto;
        }

        .py-5 {
            padding-top: 3rem !important;
            padding-bottom: 3rem !important;
        }

        .mb-5 {
            margin-bottom: 3rem !important;
        }

        .my-4 {
            margin-top: 1.5rem !important;
            margin-bottom: 1.5rem !important;
        }

        .mt-auto {
            margin-top: auto !important;
        }

        .pt-3 {
            padding-top: 1rem !important;
        }

        .spinner-border {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-bottom;
            border: 0.125em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        .spinner-border-sm {
            width: 0.875rem;
            height: 0.875rem;
            border-width: 0.125em;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container calculator-container py-5">
        <div class="header text-center mb-5">
            <h1>Stock Reprice Calculator</h1>
            <p class="lead text-muted">Analyse your stock holdings and re-pricing scenarios with precision</p>
        </div>

        <form id="repriceCalculatorForm" method="post" novalidate>
            {% csrf_token %}
            <div class="calculator-grid">
                
                <div class="card">
                    <h3 class="card-title">Current Holdings</h3>
                    
                    <div class="form-group">
                        <label for="id_stock_symbol">Stock Symbol (e.g., AAPL)</label>
                        <input type="text" name="stock_symbol" id="id_stock_symbol" class="form-control" placeholder="e.g., AAPL">
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="id_current_shares">Current Shares Held</label>
                            <input type="number" name="current_shares" id="id_current_shares" class="form-control" placeholder="e.g., 100.00" step="0.0001">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="id_average_buy_price">Average Buy Price ($)</label>
                            <input type="number" name="average_buy_price" id="id_average_buy_price" class="form-control" placeholder="e.g., 150.75" step="0.0001">
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="id_current_market_price">Current Market Price ($)</label>
                        <input type="number" name="current_market_price" id="id_current_market_price" class="form-control" placeholder="e.g., 140.20" step="0.0001">
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="form-row">
                         <div class="form-group col-md-6">
                            <label>Total Cost Price ($)</label>
                            <div class="calculated-field" id="totalCostPrice">0.00</div>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Portfolio Value ($)</label>
                            <div class="calculated-field" id="currentPortfolioValue">0.00</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Profit & Loss (P&L)</label>
                        <div class="calculated-field" id="pLInitial"><span class="pnl-value">0.00</span></div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Reprice Calculator</h3>
                    <div class="form-group">
                        <label for="id_calculation_mode">Calculation Mode</label>
                        <select name="calculation_mode" id="id_calculation_mode" class="form-control">
                            <option value="shares">Calculate by Number of Shares</option>
                            <option value="price">Calculate by Target Price</option>
                        </select>
                    </div>
                    <div class="form-group" id="sharesModeInputs">
                        <label for="id_additional_shares_to_buy">Additional Shares to Buy</label>
                        <input type="number" name="additional_shares_to_buy" id="id_additional_shares_to_buy" class="form-control" placeholder="e.g., 50.00" step="0.0001">
                    </div>
                    <div class="form-group" id="priceModeInputs" style="display: none;">
                        <label for="id_target_average_price">Target Average Price ($)</label>
                        <input type="number" name="target_average_price" id="id_target_average_price" class="form-control" placeholder="e.g., 145.00" step="0.0001">
                    </div>
                    
                    <div class="mt-auto pt-3">
                        <button type="button" class="btn btn-primary calc-btn" id="analyzeBtn">
                            Calculate Reprice
                        </button>
                        <button type="button" class="btn btn-light calc-btn" id="clearBtn">
                            Clear All Inputs
                        </button>
                    </div>

                    <hr class="dashed-divider">

                    <h3 class="card-title">Repriced Portfolio</h3>
                    <div id="dynamicResultsContent">
                        <!-- JS will populate this grid -->
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('repriceCalculatorForm');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const dynamicResultsContent = document.getElementById('dynamicResultsContent');
        const modeSelect = document.getElementById('id_calculation_mode');
        const sharesInputDiv = document.getElementById('sharesModeInputs');
        const priceInputDiv = document.getElementById('priceModeInputs');

        const placeholderResultsHtml = `
            <div class="repriced-portfolio-grid">
                <div class="form-group mb-0"><label>New Average Price ($)</label><div class="calculated-field">---</div></div>
                <div class="form-group mb-0"><label>Total Investment ($)</label><div class="calculated-field">---</div></div>
                <div class="form-group mb-0"><label>Additional Shares Needed</label><div class="calculated-field">---</div></div>
                <div class="form-group mb-0"><label>Total Shares After Purchase</label><div class="calculated-field">---</div></div>
            </div>
            <div class="form-group mt-3 mb-0"><label>Cost of New Shares ($)</label><div class="calculated-field">---</div></div>
        `;

        const formatCurrency = (value) => parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        function updateInitialCalculations() {
            const shares = parseFloat(document.getElementById('id_current_shares').value) || 0;
            const avgPrice = parseFloat(document.getElementById('id_average_buy_price').value) || 0;
            const marketPrice = parseFloat(document.getElementById('id_current_market_price').value) || 0;
            const portfolioValue = shares * marketPrice;
            const totalCost = shares * avgPrice;
            const pnl = portfolioValue - totalCost;
            
            document.getElementById('totalCostPrice').textContent = formatCurrency(totalCost);
            document.getElementById('currentPortfolioValue').textContent = formatCurrency(portfolioValue);
            const pnlSpan = document.getElementById('pLInitial').querySelector('span');
            pnlSpan.textContent = formatCurrency(Math.abs(pnl));
            pnlSpan.className = 'pnl-value';
            if (pnl > 0) { 
                pnlSpan.classList.add('text-success'); 
                pnlSpan.textContent = '+' + pnlSpan.textContent; 
            } else if (pnl < 0) { 
                pnlSpan.classList.add('text-danger'); 
                pnlSpan.textContent = '-' + pnlSpan.textContent;
            }
        }

        function toggleStrategyInputs() {
            sharesInputDiv.style.display = modeSelect.value === 'shares' ? 'block' : 'none';
            priceInputDiv.style.display = modeSelect.value === 'price' ? 'block' : 'none';
        }

        function performAnalysis() {
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Calculating...';

            // Simulate API call
            setTimeout(() => {
                const shares = parseFloat(document.getElementById('id_current_shares').value) || 0;
                const avgPrice = parseFloat(document.getElementById('id_average_buy_price').value) || 0;
                const marketPrice = parseFloat(document.getElementById('id_current_market_price').value) || 0;
                const mode = modeSelect.value;
                
                let results;
                
                if (mode === 'shares') {
                    const additionalShares = parseFloat(document.getElementById('id_additional_shares_to_buy').value) || 0;
                    const totalShares = shares + additionalShares;
                    const currentTotalCost = shares * avgPrice;
                    const newSharesCost = additionalShares * marketPrice;
                    const totalInvestment = currentTotalCost + newSharesCost;
                    const newAvgPrice = totalInvestment / totalShares;
                    
                    results = {
                        new_average_price: formatCurrency(newAvgPrice),
                        total_investment: formatCurrency(totalInvestment),
                        additional_shares_needed: additionalShares.toFixed(2),
                        total_shares_after_purchase: totalShares.toFixed(2),
                        cost_of_new_shares: formatCurrency(newSharesCost)
                    };
                } else {
                    const targetPrice = parseFloat(document.getElementById('id_target_average_price').value) || 0;
                    const currentTotalCost = shares * avgPrice;
                    const requiredShares = (currentTotalCost - (shares * targetPrice)) / (targetPrice - marketPrice);
                    const additionalShares = Math.max(0, requiredShares);
                    const totalShares = shares + additionalShares;
                    const newSharesCost = additionalShares * marketPrice;
                    const totalInvestment = currentTotalCost + newSharesCost;
                    
                    results = {
                        new_average_price: formatCurrency(targetPrice),
                        total_investment: formatCurrency(totalInvestment),
                        additional_shares_needed: additionalShares.toFixed(2),
                        total_shares_after_purchase: totalShares.toFixed(2),
                        cost_of_new_shares: formatCurrency(newSharesCost)
                    };
                }
                
                const resultsHtml = `
                    <div class="repriced-portfolio-grid">
                        <div class="form-group mb-0"><label>New Average Price ($)</label><div class="calculated-field">${results.new_average_price}</div></div>
                        <div class="form-group mb-0"><label>Total Investment ($)</label><div class="calculated-field">${results.total_investment}</div></div>
                        <div class="form-group mb-0"><label>Additional Shares Needed</label><div class="calculated-field">${results.additional_shares_needed}</div></div>
                        <div class="form-group mb-0"><label>Total Shares After Purchase</label><div class="calculated-field">${results.total_shares_after_purchase}</div></div>
                    </div>
                    <div class="form-group mt-3 mb-0"><label>Cost of New Shares ($)</label><div class="calculated-field">${results.cost_of_new_shares}</div></div>
                `;
                dynamicResultsContent.innerHTML = resultsHtml;
                
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = 'Calculate Reprice';
            }, 1000);
        }

        form.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', updateInitialCalculations);
            if(input.tagName === 'SELECT') { 
                input.addEventListener('change', toggleStrategyInputs); 
            }
        });
        
        analyzeBtn.addEventListener('click', performAnalysis);
        
        clearBtn.addEventListener('click', () => {
            form.reset();
            const event = new Event('input', { bubbles: true });
            form.querySelectorAll('input, select').forEach(input => input.dispatchEvent(event));
            dynamicResultsContent.innerHTML = placeholderResultsHtml;
        });

        updateInitialCalculations();
        toggleStrategyInputs();
        dynamicResultsContent.innerHTML = placeholderResultsHtml;
    });
    </script>
{% endblock content %}